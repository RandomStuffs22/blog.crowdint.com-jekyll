<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Crowd Interactive Tech Blog :: Blog</title>
  <link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/stylesheets/print.css" type="text/css" media="print" />
  <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/skribit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" />
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for blog.crowdint.com" href="http://feeds.feedburner.com/CrowdInteractiveTechBlog" />
  <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];

      _gaq.push(['_setAccount', 'UA-17527068-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</head>
<body>
  <div class="container">
    <div id="empty-header">
      <a href="/" id="home-link"><img src="/images/logo_03.png" id="logoHead" width="227" height="74" alt="LogoHead" onclick="_gaq.push(['_trackEvent', 'header', 'logo']);"/></a>
      <ul id="navMenu">
        <li><a href="http://www.crowdint.com/" onclick="_gaq.push(['_trackEvent', 'header', 'home']);"><span>HOME</span></a></li>
        <li><a href="http://www.crowdint.com/en/projects" onclick="_gaq.push(['_trackEvent', 'header', 'projects']);"><span>PROJECTS</span></a></li>
        <li><a href="http://www.crowdint.com/en/services" onclick="_gaq.push(['_trackEvent', 'header', 'services']);"><span>SERVICES</span></a></li>
        <li class="selected"><span>BLOG</span></li>
        <li><a href="http://www.crowdint.com/en/about_us" onclick="_gaq.push(['_trackEvent', 'header', 'about_us']);"><span>ABOUT</span></a></li>
        <li><a href="http://www.crowdint.com/" onclick="_gaq.push(['_trackEvent', 'header', 'contact']);"><span>CONTACT</span></a></li>
      </ul>
    </div>
    <div class="span-24 append-bottom testGlow">
      <div class="round-top span-24">
        &nbsp;
      </div>
      <div id="white-body" class="span-24">
        <div class="left-side span-17">
          
<div class="post prepend-1">
  <h1><a href="/2011/02/05/auditrail-how-to-play-dirty-with-callbacks.html">Auditrail, how to play dirty with callbacks.</a></h1>
  <p class="author">
    <span class="date"><b>Feb 05</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/1e7f8fb8733b6193cf3bdbc85693f515" class="avatar" alt="Avatar" /></div>
    <p>Recently, we've been working in a very interesting project here at Crowd Interactive. We needed to audit some of our models
in order to keep track of their changes, among other things. We searched for options (you know, plugins, gems, etc.)
to help us accomplish that task. We found a few ones, but eventually we came to a dead end when those tools
were not fitting our expectations, they were either too complicated or too rough for our needs. So, we decided to
create a new solution named <a href="http://github.com/crowdint/auditrail">auditrail</a>.</p>

<p>Auditrail is a gem that provides a highly configurable solution to audit your models. It provides two generators.
The first one creates the Audit model with a couple of methods that helps you use it, and the second creates the migration for its table.</p>

<h2>How is it used?</h2>

<p>Quite simple. You just need to install the <em>auditrail</em> gem, and then, run the generators provided
(<em>auditrail:migrations</em> and <em>auditrail:model</em>). Then you just need to call the method <em>auditable</em>
in the models you want to audit, and, that's it!</p>

<h2>How does it work?</h2>

<p>Auditrail was built to make it easily and readable. So, if you take a quick look at the source code
you can identify all the components.</p>

<ul>
<li><p>Auditrail keeps track of the changes in the audited models through the Audit model. Here, you can configure your own methods to manipulate those changes, or, you can place your filters or special actions.</p></li>
<li><p>Auditrail is a module that extends <em>ActiveRecord::Base</em>, so you can use it just by calling the <em>auditable</em>
method on the models you want to Audit. Simple, isn't it?</p></li>
<li><p>In order to manipulate the plugin requests auditrail uses a basic DSL to handle the method calls.
Those methods where built to specify a list of the attributes that you want to audit
and/or include the actor that is making the changes to the audited model.</p></li>
<li><p>It extends the ActiveSupport::Concern to facilitate the manipulation of the instance methods and the
class methods in the same module, dealing with the necessity to include an extend for the ActiveRecord::Base. Example:</p></li>
</ul>


<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">Auditrail</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>

    <span class="k">def</span> <span class="nf">some_method</span>
      <span class="c1"># Include some code for your class method...</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">InstanceMethods</span>

    <span class="k">def</span> <span class="nf">track_changes</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
      <span class="c1"># Include some code for your instance method...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="no">Auditrail</span><span class="p">)</span>
</code></pre>
</div>


<ul>
<li><p>Auditrail uses ActiveRecord <em>callbacks</em> to trigger the methods that actually audit the models.</p></li>
<li><p>Once auditrail knows when an object is modified it will track the changes using <em>ActiveModel::Dirty</em>.</p></li>
<li><p>ActiveModel::Dirty returns a hash that we serialize in order to save them in our Audit model.</p></li>
<li><p>All these changes will be stored in the <em>dumped_changes</em> field on the audits table.</p></li>
</ul>


<p>*The dumped_changes fields is generated with type <strong>string</strong> by default, in case you're planing to track big models,
you should change its type to <strong>text</strong>.</p>

<p>Here you can find a list with the attributes on the Audit model:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">==============</span>  <span class="o">====</span>      <span class="o">===========================================================================</span>
<span class="no">Attribute</span>         <span class="no">Type</span>      <span class="no">Usage</span>
<span class="o">--------------</span>  <span class="o">----</span>      <span class="o">---------------------------------------------------------------------------</span>
<span class="ss">:dumped_changes</span>    <span class="n">text</span>      <span class="no">Keep</span> <span class="n">the</span> <span class="n">changes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">model</span> <span class="n">serialized</span><span class="o">.</span>
<span class="ss">:action</span>            <span class="n">string</span>    <span class="no">Indicates</span> <span class="n">whether</span> <span class="n">was</span> <span class="n">creation</span> <span class="p">(</span><span class="s2">&quot;creating&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">update</span> <span class="p">(</span><span class="s2">&quot;updating&quot;</span><span class="p">)</span><span class="o">.</span>
<span class="ss">:model_changed</span>     <span class="n">string</span>    <span class="no">Indicates</span> <span class="n">the</span> <span class="n">model</span> <span class="n">that</span> <span class="n">changed</span><span class="o">.</span>
<span class="ss">:element_id</span>        <span class="n">integer</span>   <span class="no">Indicates</span> <span class="n">the</span> <span class="n">element</span> <span class="n">from</span> <span class="n">the</span> <span class="n">audited</span> <span class="n">model</span> <span class="n">that</span> <span class="n">has</span> <span class="n">changed</span><span class="o">.</span>
<span class="ss">:invoker</span>           <span class="n">string</span>    <span class="no">Optional</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">chose</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">store</span> <span class="n">the</span> <span class="n">action</span> <span class="n">invoker</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span>
<span class="ss">:timestamps</span>                  <span class="no">You</span> <span class="n">can</span> <span class="n">use</span> <span class="n">the</span> <span class="n">timestamps</span> <span class="n">to</span> <span class="n">determine</span> <span class="k">when</span> <span class="n">the</span> <span class="n">audited</span> <span class="n">model</span> <span class="n">has</span> <span class="n">changed</span><span class="o">.</span>
<span class="o">==============</span>  <span class="o">=======</span>   <span class="o">===========================================================================</span>
</code></pre>
</div>


<p>As with all open source projects, feel free to collaborate with this
gem by forking it on github.</p>

    <div class="author_box">
      <p><b>Author:</b> Luis Galaviz | luis.galaviz@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/02/05/auditrail-how-to-play-dirty-with-callbacks.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="post prepend-1">
  <h1><a href="/2011/01/31/attack-of-the-backticks.html">Attack of the backtick</a></h1>
  <p class="author">
    <span class="date"><b>Jan 31</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/d32b52ec6403614b1adf3e648cbbe584" class="avatar" alt="Avatar" /></div>
    <p>It all started because I was getting some weird warning while running
the specs on one of my apps.</p>

<p>I know that, as a developer, I am suppposed to ignore all warnings, but,
this one felt ackward, so I had to track it down.</p>

<div class="highlight"><pre><code class="bash">/Users/dab/.rvm/gems/ree-1.8.7-2010.02@project/gems/activerecord-3.0.3/lib/active_record/base.rb:1838: <span class="nb">command </span>not found:
</code></pre>
</div>


<p>What? Why is activerecord trying to run some command? what command? and
why it isn't finding that command?</p>

<p>Let's figure it out. So, I opened base.rb an went to line 1838 and all I saw was
something like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">convert_number_column_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="kp">false</span>
    <span class="mi">0</span>
  <span class="k">elsif</span> <span class="n">value</span> <span class="o">==</span> <span class="kp">true</span>
    <span class="mi">1</span>
  <span class="k">elsif</span> <span class="n">value</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="n">blank?</span>
    <span class="kp">nil</span>
  <span class="k">else</span>
    <span class="n">value</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Nothing useful there, line 1838 was just doing some if thing. So, what's
going on?</p>

<p>I went through lots of source files, trying to narrow down the
posibilites. But I just couldn't find anything unusual. If there was a
syntax error, why is the code not breaking completely, it's just a
warning on STDOUT.</p>

<p>I ended up doing the worst thing ever (for me, anyway) to figure out this
one, run the code with <em>ruby-debug</em>, put a couple of breakpoints. I feel
dirty just by admiting that.</p>

<p>Anyway, the problem was caused by some unintentional mistake:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">items_returned</span> <span class="o">&lt;&lt;</span> <span class="n">item</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cancelled?</span><span class="sb">``</span>
</code></pre>
</div>


<p>How could I have missed that? the <em>backticks</em> at the end of the line, of
course.</p>

<p>In ruby, the backtick method returns the standard output of running the string encompassed
by the backticks in a subshell.</p>

<p>Yes, it is a method, like almost every operator in Ruby.</p>

<p>A few examples:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">hey</span> <span class="o">=</span> <span class="sb">`echo hey`</span> <span class="c1"># =&gt; &quot;hey\n&quot;</span>
<span class="n">list_of_files</span> <span class="o">=</span> <span class="sb">`ls`</span> <span class="c1"># =&gt; &quot;file1\nfile2\nfile3\n&quot;</span>
</code></pre>
</div>


<p>It also sets a special variable $? with a Process::Status object with
the PID of that subshell.</p>

<div class="highlight"><pre><code class="ruby"><span class="sb">`exit 99`</span>
<span class="vg">$?</span>           <span class="c1">#  =&gt; # &lt;Process::Status: pid 7781 exit 99&gt;</span>
<span class="vg">$.</span><span class="n">exitstatus</span> <span class="c1">#  =&gt; 99</span>
</code></pre>
</div>


<p>So, I guess what was happening is that, the <em>cancelled?</em> method was
taking the result of `` as a parameter, in this case, a string, printing the result of that to
STDOUT and just ignoring the value of the parameter.</p>

<p>In other words, I was calling <em>cancelled?</em> like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">cancelled?</span><span class="p">(</span><span class="sb">``</span><span class="p">)</span>
</code></pre>
</div>


<p>But, since cancelled wasn't expecting a parameter at all, it just
ignored the input. That's why I wasn't getting a syntax error or a
runtime error.</p>

<p>Probably nothing useful on my experience, since this is such a weird
problem to have, yet I just felt like explaining the power of the backticks.</p>

<p>Cheers</p>

    <div class="author_box">
      <p><b>Author:</b> David Padilla | david@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/01/31/attack-of-the-backticks.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="post prepend-1">
  <h1><a href="/2011/01/24/how-to-start-writing-a-gem.html">How to start writing a ruby gem</a></h1>
  <p class="author">
    <span class="date"><b>Jan 24</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/d32b52ec6403614b1adf3e648cbbe584" class="avatar" alt="Avatar" /></div>
    <p>If you are a Ruby developer, by now, you have probably used tons of
gems in your apps.</p>

<p>That's one of the best things of using Ruby, a lot of people writes
repeatable code that you can easily integrate into your own apps.</p>

<p>In this brief tutorial, I will try to explain the basic things you need
to know in order to start writing your own gems, you know, just in case
you have something to share with the world.</p>

<h2>Setting up the folders</h2>

<p>We'll start by creating the gem folder structure using Bundler.</p>

<p>First thing you have to do is, install bundler itself. Easy.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>gem install bundler
</code></pre>
</div>


<p>Now, bundler comes with a handy command to generate the basic files to
start writing a gem.</p>

<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">bundler</span> <span class="n">gem</span> <span class="n">awesome_gem</span>

  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="no">Gemfile</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="no">Rakefile</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/.</span><span class="n">gitignore</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">.</span><span class="n">gemspec</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">.</span><span class="n">rb</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">/</span><span class="n">version</span><span class="o">.</span><span class="n">rb</span>
</code></pre>
</div>


<h2>The Gemspec</h2>

<p>All gems have a <em>.gemspec</em> file. This files contains all the info on your
gem. The name, a description, dependencies. Let's open it and see how it
looks.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;awesome_gem/version&quot;</span>

<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="n">s</span><span class="o">.</span><span class="n">platform</span>    <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Platform</span><span class="o">::</span><span class="no">RUBY</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;TODO: Write your name&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;TODO: Write your email address&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="sx">%q{TODO: Write a gem summary}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="sx">%q{TODO: Write a gem description}</span>

  <span class="n">s</span><span class="o">.</span><span class="n">rubyforge_project</span> <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>

  <span class="n">s</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="sb">`git ls-files -- {test,spec,features}/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="sb">`git ls-files -- bin/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Now, all you have to do is replace some of the fields here with your own
information.</p>

<p>The only things that is not explicitily given is a place to define
dependencies.</p>

<p>Also, you have to declare your gem's dependencies to other gems, if any.</p>

<p>Let's say your gem heavily depends on <em>rails</em>. Then, you have to add a
line to state so:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.0&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>You use shoulda or mocha? Since you use them only to test it while
developing, you define it as a <em>development dependency</em>.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;shoulda&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;mocha&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>So, our .gemspec file ends up loking like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;awesome_gem/version&quot;</span>

<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="n">s</span><span class="o">.</span><span class="n">platform</span>    <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Platform</span><span class="o">::</span><span class="no">RUBY</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;David Padilla&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;david@crowdint.com&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="sx">%q{A gem that will change the world}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="sx">%q{A long description for a gem that will change the world}</span>

  <span class="n">s</span><span class="o">.</span><span class="n">rubyforge_project</span> <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>

  <span class="n">s</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="sb">`git ls-files -- {test,spec,features}/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="sb">`git ls-files -- bin/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>

  <span class="n">s</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.0&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;shoulda&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;mocha&#39;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>


<p>The best thing about this is that now, you can just run the <em>bundler
install</em> command, and you will get the gem dependencies installed on your
computer.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>bundler install

  Installing rails <span class="o">(</span>3.0.0<span class="o">)</span>
  Using mocha <span class="o">(</span>0.9.10<span class="o">)</span>
  Using shoulda <span class="o">(</span>2.11.3<span class="o">)</span>
  ...
</code></pre>
</div>


<p>For more information on what should be on this file, you can read the
<a href="http://docs.rubygems.org/read/chapter/20">specification here</a>.</p>

<h3>The code</h3>

<p>By definition, you have a file called <em>lib/THE_NAME_OF_YOUR_GEM.rb</em> that
will be called when you require your gem on any piece of ruby code.</p>

<p>Usually, your gem will have a lot of code spread in Modules and Classes.
This file should only work as the glue to put everything together.</p>

<p>Let's say your gem introduces a new class called <em>Mushroom</em>. You will
have to create a <em>lib/mushroom.rb</em> file with the class definition:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Mushroom</span>
  <span class="c1"># Some code</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</code></pre>
</div>


<p>And then, require it on <em>lib/awesome_gem.rb</em></p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;mushroom&#39;</span>
</code></pre>
</div>


<p>And so on. Obviously, you will probably want to put the classes and
their files on a namespace hierarchy. Create folders for each namespace.</p>

<p>So, if for example, you had some classes that are used to access
different stuff, you want to create an Accessor namespace and put all
the classes on the <em>lib/accessors</em> folder.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Accessor</span><span class="o">::</span><span class="no">TextFileAccessor</span>

<span class="k">end</span>
</code></pre>
</div>


<p>From here on, you have to rely on <em>Ruby Metaprogramming</em>, but I'll leave
that for another post.</p>

<h2>Unit tests</h2>

<p>To include some rake tasks to test your gem, add the following lines to
<em>Rakefile</em>.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;rake/testtask&#39;</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:test</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">test</span><span class="o">|</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">libs</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;lib&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;test&#39;</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;test/**/test_*.rb&#39;</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>


<p>This will add a <em>rake test</em> rake task that will run all the tests that
you define on the <em>test</em> folder.</p>

<p>You can also install rspec, bacon, minitest or any test framework of
your choice. Read each of their documentation to find out how to add
them to your gem.</p>

<h2>Testing your code on an existing app</h2>

<p>Obviously, to test your gem, you'd use something like <em>rspec</em> or
<em>minitest</em>, but, just in case you want to see how it will end up working
on an existing app that uses Bundler, you can add it to the other's app
Gemfile and specify the local path to use the local version of the gem
instead of downloading it from a repo:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s1">&#39;awesome_gem&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/Users/some_path/awesome_gem&#39;</span>
</code></pre>
</div>


<p>This way, any change you make on the gem will be immediately reflected
on the app where you installed it.</p>

<h2>Deploying to rubygems.org</h2>

<p>Once you are done writing some awesome ruby code, it's time to deploy
your app for everyone to use.</p>

<p>All you have to do is run</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>rake release
</code></pre>
</div>


<p>And this will publish your gem to rubygems.org.</p>

<h2>Version</h2>

<p>To have control over hav your gem changes overtime, you want to use a
version.</p>

<p>Your gem's version is defined on the <em>lib/awesome_gem/version.rb</em> file.</p>

<p>If you open it, you'll see that there's only one line on the file:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">AwesomeGem</span>
  <span class="no">VERSION</span> <span class="o">=</span> <span class="s2">&quot;0.0.1&quot;</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Remember this line on the gemspec?</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
</code></pre>
</div>


<p>This means that, the version defined on the gemspec is being pulled from
this file.</p>

<p>It also means that you can access the version of the gem from anywhere
in the code, even on the code where you are using the gem.</p>

<p>So, you can do things like:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">if</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span> <span class="o">==</span> <span class="s1">&#39;1.0.0&#39;</span>
  <span class="c1"># Do it this way for verision 1.0.0</span>
<span class="k">else</span>
  <span class="c1"># For all the other versions do it that way</span>
<span class="k">end</span>
</code></pre>
</div>


<p>This, of course, is not recommended and should be only used in case
where there's no other solution, or, to display deprecation messages.</p>

<h2>Conclusion</h2>

<p>Before writing a gem, make sure you google around and browse github for
the behavior that you are looking for. Most of the times, someone already
thought of a generic solution for your problem. Sometimes you won't
like that solution and you'll end up writing your own gem, sometimes
you will like it and use it.</p>

<p>Contributing is what keeps the community alive, write lots of gems!</p>

<p>Hope this points you in the right direction.</p>

    <div class="author_box">
      <p><b>Author:</b> David Padilla | david@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/01/24/how-to-start-writing-a-gem.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="pagination prepend-1">
  
    <a href="/page1" class="previous">Previous</a>
  
  <span class="page_number ">Page: 2 of 13</span>
  
    <a href="/page3" class="next ">Next</a>
  
</div>






<div class="post prepend-1">
  <h1>Recent Posts</h1>
  <ul class="archives">

  <li><span><b>25 Feb 2011</b></span> &raquo; <a href="/2011/02/25/why-ruby.html">Why ruby?</a></li>

  <li><span><b>21 Feb 2011</b></span> &raquo; <a href="/2011/02/21/what-we-learned-at-la-ruby-conf.html">What we learned at LA Ruby Conf</a></li>

  <li><span><b>15 Feb 2011</b></span> &raquo; <a href="/2011/02/15/internationalizing-your-rails-app.html">Internationalizing your Rails application with i18n</a></li>

  <li><span><b>05 Feb 2011</b></span> &raquo; <a href="/2011/02/05/auditrail-how-to-play-dirty-with-callbacks.html">Auditrail, how to play dirty with callbacks.</a></li>

  <li><span><b>31 Jan 2011</b></span> &raquo; <a href="/2011/01/31/attack-of-the-backticks.html">Attack of the backtick</a></li>

  <li><span><b>24 Jan 2011</b></span> &raquo; <a href="/2011/01/24/how-to-start-writing-a-gem.html">How to start writing a ruby gem</a></li>

  <li><span><b>14 Jan 2011</b></span> &raquo; <a href="/2011/01/14/building-a-basic-dsl-to-create-callbacks-in-ruby.html">Building a basic DSL to create callbacks in Ruby</a></li>

  <li><span><b>05 Jan 2011</b></span> &raquo; <a href="/2011/01/05/custom-sorting-with-ruby.html">Custom Sorting with Ruby</a></li>

  <li><span><b>25 Dec 2010</b></span> &raquo; <a href="/2010/12/25/happy-holidays-from-crowd-interactive.html">Happy Holidays, your friends from Crowd Interactive</a></li>

  <li><span><b>21 Dec 2010</b></span> &raquo; <a href="/2010/12/21/cool-date-formatting-in-rails.html">Cool date formatting in Rails</a></li>

  <li><span><b>15 Dec 2010</b></span> &raquo; <a href="/2010/12/15/always-think-restful.html">Always Think RESTful</a></li>

  <li><span><b>07 Dec 2010</b></span> &raquo; <a href="/2010/12/07/improving-your-dev-life-with-ree.html">Improving your development life with Ruby Enterprise Edition</a></li>

  <li><span><b>30 Nov 2010</b></span> &raquo; <a href="/2010/11/30/rspec-for-really-newbies.html">RSpec for really newbies</a></li>

  <li><span><b>24 Nov 2010</b></span> &raquo; <a href="/2010/11/24/watermarking-images.html">Watermarking images minimizing the overhead</a></li>

  <li><span><b>17 Nov 2010</b></span> &raquo; <a href="/2010/11/17/rack-basics-a-rack-introduction.html">Rack Basics - A Rack Introduction</a></li>

  <li><span><b>11 Nov 2010</b></span> &raquo; <a href="/2010/11/11/subdomains-in-rails-2-and-3.html">Subdomains in Rails (2.3.x &amp; 3)</a></li>

  <li><span><b>05 Nov 2010</b></span> &raquo; <a href="/2010/11/05/controller-responders-in-rails-3.html">Controller responders in Rails 3</a></li>

  <li><span><b>01 Nov 2010</b></span> &raquo; <a href="/2010/11/01/ignoring-files-with-git.html">Ignoring files with Git</a></li>

  <li><span><b>27 Oct 2010</b></span> &raquo; <a href="/2010/10/27/working-with-postgresql-and-rails3.html">Working with PostgreSQL and Rails3</a></li>

  <li><span><b>22 Oct 2010</b></span> &raquo; <a href="/2010/10/22/improve-your-seo-with-a-sitemap.html">Improve your SEO with a sitemap</a></li>

  </ul>
</div>

        </div>
        <div class="right-side span-5 last prepend-1">
          <h1><a href="/">Blog Home</a></h1>
<h1>About Crowd Interactive</h1>
<p class="append-1 about">Crowd Interactive is a Ruby on Rails
consultancy firm powered by a team of enthusiast engineers that love
programming.We turn your ideas into web applications...<br/><a href="/about.html">Read More...</a></p>
<div id="writeSkribitHere"></div><script src="http://assets.skribit.com/javascripts/SkribitWidget.js?renderTo=writeSkribitHere&amp;blog=ef56d1750b6040b271e0080ef2886f3b&amp;cnt=5&noCSS=1"></script><noscript>Sorry, but the <a href="http://skribit.com" title="Skribit - Cure Writer's Block">Skribit</a> widget only works on browsers with JavaScript support.  <a href="http://skribit.com/blogs/crowdint-tech" title="Skribit Suggestions for Crowdint Tech">View suggestions for this blog here.</a></noscript>
<h1>Our Favorite Sites</h1>
<ul>
  <li><a href="http://www.crowdint.com">Crowd Interactive</a></li>
  <li><a href="http://www.magmarails.com">MagmaRails</a></li>
  <li><a href="http://rubyonrails.org">Ruby on Rails</a></li>
  <li><a href="http://ruby-lang.org">Ruby-Lang</a></li>
  <li><a href="http://github.com/crowdint">Github</a></li>
</ul>
<h1>Stuff we've built</h1>
<ul>
  <li><a href="http://www.modcloth.com">ModCloth</a></li>
  <li><a href="http://www.creativeallies.com">Creative Allies</a></li>
  <li><a href="http://www.nameframe.com">Nameframe</a></li>
  <li><a href="http://github.com/crowdint/rails3-jquery-autocomplete">Rails3-jQuery-Autocomplete</a></li>
  <li><a href="http://github.com/crowdint/rankstar">rankstar</a></li>
  <li><a href="http://github.com/crowdint/blog.crowdint.com">This site's source code</a></li>
</ul>
<h1>Older Posts</h1>
<ul>
  <li><a href="/archive.html">Archive</a></li>
</ul>

Site Powered by <a href="http://github.com/mojombo/jekyll">Jekyll</a>

        </div>
      </div>
      <div class="round-bottom span-24">
        &nbsp;
      </div>
    </div>

  </div>
  <div id="footer">
    <div class="copyContent" >
      <p class="copy">Copyright &copy; 2010, Crowd Interactive. All rights reserved.</p>
    </div>
  </div>
  <script type="text/javascript">
  var disqus_shortname = 'crowdinttech';
  (function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/crowdinttech/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
  </script>
</body>
</html>
