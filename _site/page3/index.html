<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Crowd Interactive Tech Blog :: Blog</title>
  <link rel="stylesheet" href="/stylesheets/screen.css?853991" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/stylesheets/print.css" type="text/css" media="print" />
  <link rel="stylesheet" href="/stylesheets/styles.css?853991" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/skribit.css" type="text/css" media="screen" />
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" />
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for blog.crowdint.com" href="http://feeds.feedburner.com/CrowdInteractiveTechBlog" />
  <link href='http://fonts.googleapis.com/css?family=Arvo' rel='stylesheet' type='text/css'>
  <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"><![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];

      _gaq.push(['_setAccount', 'UA-17527068-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</head>
<body>
  <div class="container">
    <div id="empty-header">
      <a href="/" id="home-link"><img src="/images/logo_03.png" id="logoHead" width="227" height="74" alt="LogoHead" onclick="_gaq.push(['_trackEvent', 'header', 'logo']);"/></a>
      <ul id="navMenu">
        <li><a href="http://www.crowdint.com/" onclick="_gaq.push(['_trackEvent', 'header', 'home']);"><span>HOME</span></a></li>
        <li><a href="http://www.crowdint.com/en/projects" onclick="_gaq.push(['_trackEvent', 'header', 'projects']);"><span>PROJECTS</span></a></li>
        <li><a href="http://www.crowdint.com/en/services" onclick="_gaq.push(['_trackEvent', 'header', 'services']);"><span>SERVICES</span></a></li>
        <li class="selected"><span>BLOG</span></li>
        <li><a href="http://www.crowdint.com/en/about_us" onclick="_gaq.push(['_trackEvent', 'header', 'about_us']);"><span>ABOUT</span></a></li>
        <li><a href="http://www.crowdint.com/" onclick="_gaq.push(['_trackEvent', 'header', 'contact']);"><span>CONTACT</span></a></li>
      </ul>
    </div>
    <div class="span-24 append-bottom testGlow">
      <div class="round-top span-24">
        &nbsp;
      </div>
      <div id="white-body" class="span-24">
        <div class="left-side span-17">
          
<div class="post prepend-1">
  <h1><a href="/2011/01/24/how-to-start-writing-a-gem.html">How to start writing a ruby gem</a></h1>
  <p class="author">
    <span class="date"><b>Jan 24</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/d32b52ec6403614b1adf3e648cbbe584" class="avatar" alt="Avatar" /></div>
    <p>If you are a Ruby developer, by now, you have probably used tons of
gems in your apps.</p>

<p>That's one of the best things of using Ruby, a lot of people writes
repeatable code that you can easily integrate into your own apps.</p>

<p>In this brief tutorial, I will try to explain the basic things you need
to know in order to start writing your own gems, you know, just in case
you have something to share with the world.</p>

<h2>Setting up the folders</h2>

<p>We'll start by creating the gem folder structure using Bundler.</p>

<p>First thing you have to do is, install bundler itself. Easy.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>gem install bundler
</code></pre>
</div>


<p>Now, bundler comes with a handy command to generate the basic files to
start writing a gem.</p>

<div class="highlight"><pre><code class="ruby"><span class="err">$</span> <span class="n">bundler</span> <span class="n">gem</span> <span class="n">awesome_gem</span>

  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="no">Gemfile</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="no">Rakefile</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/.</span><span class="n">gitignore</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">.</span><span class="n">gemspec</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">.</span><span class="n">rb</span>
  <span class="n">create</span>  <span class="n">awesome_gem</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">awesome_gem</span><span class="o">/</span><span class="n">version</span><span class="o">.</span><span class="n">rb</span>
</code></pre>
</div>


<h2>The Gemspec</h2>

<p>All gems have a <em>.gemspec</em> file. This files contains all the info on your
gem. The name, a description, dependencies. Let's open it and see how it
looks.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;awesome_gem/version&quot;</span>

<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="n">s</span><span class="o">.</span><span class="n">platform</span>    <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Platform</span><span class="o">::</span><span class="no">RUBY</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;TODO: Write your name&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;TODO: Write your email address&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="sx">%q{TODO: Write a gem summary}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="sx">%q{TODO: Write a gem description}</span>

  <span class="n">s</span><span class="o">.</span><span class="n">rubyforge_project</span> <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>

  <span class="n">s</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="sb">`git ls-files -- {test,spec,features}/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="sb">`git ls-files -- bin/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Now, all you have to do is replace some of the fields here with your own
information.</p>

<p>The only things that is not explicitily given is a place to define
dependencies.</p>

<p>Also, you have to declare your gem's dependencies to other gems, if any.</p>

<p>Let's say your gem heavily depends on <em>rails</em>. Then, you have to add a
line to state so:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.0&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>You use shoulda or mocha? Since you use them only to test it while
developing, you define it as a <em>development dependency</em>.</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;shoulda&#39;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;mocha&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>So, our .gemspec file ends up loking like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;awesome_gem/version&quot;</span>

<span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
  <span class="n">s</span><span class="o">.</span><span class="n">name</span>        <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
  <span class="n">s</span><span class="o">.</span><span class="n">platform</span>    <span class="o">=</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Platform</span><span class="o">::</span><span class="no">RUBY</span>
  <span class="n">s</span><span class="o">.</span><span class="n">authors</span>     <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;David Padilla&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">email</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;david@crowdint.com&quot;</span><span class="o">]</span>
  <span class="n">s</span><span class="o">.</span><span class="n">homepage</span>    <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">summary</span>     <span class="o">=</span> <span class="sx">%q{A gem that will change the world}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="sx">%q{A long description for a gem that will change the world}</span>

  <span class="n">s</span><span class="o">.</span><span class="n">rubyforge_project</span> <span class="o">=</span> <span class="s2">&quot;awesome_gem&quot;</span>

  <span class="n">s</span><span class="o">.</span><span class="n">files</span>         <span class="o">=</span> <span class="sb">`git ls-files`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">test_files</span>    <span class="o">=</span> <span class="sb">`git ls-files -- {test,spec,features}/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">executables</span>   <span class="o">=</span> <span class="sb">`git ls-files -- bin/*`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">s</span><span class="o">.</span><span class="n">require_paths</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lib&quot;</span><span class="o">]</span>

  <span class="n">s</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.0&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;shoulda&#39;</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">add_development_dependency</span><span class="p">(</span><span class="s1">&#39;mocha&#39;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>


<p>The best thing about this is that now, you can just run the <em>bundler
install</em> command, and you will get the gem dependencies installed on your
computer.</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>bundler install

  Installing rails <span class="o">(</span>3.0.0<span class="o">)</span>
  Using mocha <span class="o">(</span>0.9.10<span class="o">)</span>
  Using shoulda <span class="o">(</span>2.11.3<span class="o">)</span>
  ...
</code></pre>
</div>


<p>For more information on what should be on this file, you can read the
<a href="http://docs.rubygems.org/read/chapter/20">specification here</a>.</p>

<h3>The code</h3>

<p>By definition, you have a file called <em>lib/THE_NAME_OF_YOUR_GEM.rb</em> that
will be called when you require your gem on any piece of ruby code.</p>

<p>Usually, your gem will have a lot of code spread in Modules and Classes.
This file should only work as the glue to put everything together.</p>

<p>Let's say your gem introduces a new class called <em>Mushroom</em>. You will
have to create a <em>lib/mushroom.rb</em> file with the class definition:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Mushroom</span>
  <span class="c1"># Some code</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span>
</code></pre>
</div>


<p>And then, require it on <em>lib/awesome_gem.rb</em></p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;mushroom&#39;</span>
</code></pre>
</div>


<p>And so on. Obviously, you will probably want to put the classes and
their files on a namespace hierarchy. Create folders for each namespace.</p>

<p>So, if for example, you had some classes that are used to access
different stuff, you want to create an Accessor namespace and put all
the classes on the <em>lib/accessors</em> folder.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Accessor</span><span class="o">::</span><span class="no">TextFileAccessor</span>

<span class="k">end</span>
</code></pre>
</div>


<p>From here on, you have to rely on <em>Ruby Metaprogramming</em>, but I'll leave
that for another post.</p>

<h2>Unit tests</h2>

<p>To include some rake tasks to test your gem, add the following lines to
<em>Rakefile</em>.</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;rake/testtask&#39;</span>
<span class="no">Rake</span><span class="o">::</span><span class="no">TestTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:test</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="nb">test</span><span class="o">|</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">libs</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;lib&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;test&#39;</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;test/**/test_*.rb&#39;</span>
  <span class="nb">test</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>


<p>This will add a <em>rake test</em> rake task that will run all the tests that
you define on the <em>test</em> folder.</p>

<p>You can also install rspec, bacon, minitest or any test framework of
your choice. Read each of their documentation to find out how to add
them to your gem.</p>

<h2>Testing your code on an existing app</h2>

<p>Obviously, to test your gem, you'd use something like <em>rspec</em> or
<em>minitest</em>, but, just in case you want to see how it will end up working
on an existing app that uses Bundler, you can add it to the other's app
Gemfile and specify the local path to use the local version of the gem
instead of downloading it from a repo:</p>

<div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s1">&#39;awesome_gem&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/Users/some_path/awesome_gem&#39;</span>
</code></pre>
</div>


<p>This way, any change you make on the gem will be immediately reflected
on the app where you installed it.</p>

<h2>Deploying to rubygems.org</h2>

<p>Once you are done writing some awesome ruby code, it's time to deploy
your app for everyone to use.</p>

<p>All you have to do is run</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>rake release
</code></pre>
</div>


<p>And this will publish your gem to rubygems.org.</p>

<h2>Version</h2>

<p>To have control over hav your gem changes overtime, you want to use a
version.</p>

<p>Your gem's version is defined on the <em>lib/awesome_gem/version.rb</em> file.</p>

<p>If you open it, you'll see that there's only one line on the file:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">AwesomeGem</span>
  <span class="no">VERSION</span> <span class="o">=</span> <span class="s2">&quot;0.0.1&quot;</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Remember this line on the gemspec?</p>

<div class="highlight"><pre><code class="ruby"><span class="n">s</span><span class="o">.</span><span class="n">version</span>     <span class="o">=</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span>
</code></pre>
</div>


<p>This means that, the version defined on the gemspec is being pulled from
this file.</p>

<p>It also means that you can access the version of the gem from anywhere
in the code, even on the code where you are using the gem.</p>

<p>So, you can do things like:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">if</span> <span class="no">AwesomeGem</span><span class="o">::</span><span class="no">VERSION</span> <span class="o">==</span> <span class="s1">&#39;1.0.0&#39;</span>
  <span class="c1"># Do it this way for verision 1.0.0</span>
<span class="k">else</span>
  <span class="c1"># For all the other versions do it that way</span>
<span class="k">end</span>
</code></pre>
</div>


<p>This, of course, is not recommended and should be only used in case
where there's no other solution, or, to display deprecation messages.</p>

<h2>Conclusion</h2>

<p>Before writing a gem, make sure you google around and browse github for
the behavior that you are looking for. Most of the times, someone already
thought of a generic solution for your problem. Sometimes you won't
like that solution and you'll end up writing your own gem, sometimes
you will like it and use it.</p>

<p>Contributing is what keeps the community alive, write lots of gems!</p>

<p>Hope this points you in the right direction.</p>

    <div class="author_box">
      <p><b>Author:</b> David Padilla | david@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/01/24/how-to-start-writing-a-gem.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="post prepend-1">
  <h1><a href="/2011/01/14/building-a-basic-dsl-to-create-callbacks-in-ruby.html">Building a basic DSL to create callbacks in Ruby</a></h1>
  <p class="author">
    <span class="date"><b>Jan 14</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/a302e7dd208f335dc67761a6db911561" class="avatar" alt="Avatar" /></div>
    <p>Do you know what a <strong>Domain Specific Language(DSL)</strong> is and how to
implement one in Ruby?. This article aims to provide a slight introduction
to this topic. It is divided in 3 sections, first we'll define what a DSL is,
second we'll see some examples of DSL implementations, and third we'll build
a DSL.</p>

<h2>What is a DSL?</h2>

<p><a href="http://en.wikipedia.org/wiki/Domain-specific_language">According wikipedia</a> a
DSL is defined as:</p>

<blockquote><p>In software development and domain engineering, a domain-specific
language (DSL) is a programming language or specification language dedicated
to a particular problem domain, a particular problem representation
technique, and/or a particular solution technique.</p></blockquote>

<p>To clarify, we'll see some examples. As you read through them take into account
the following points:</p>

<ul>
<li><a href="http://rubylearning.com/satishtalim/ruby_blocks.html">Ruby blocks</a>
are used everywhere. They are the bare minimum construction element.</li>
<li>Though the used structures are not part of the Ruby core, all of
them use valid Ruby constructs.</li>
<li>The main purpose of creating new code structure is to provide a more
<em>human readable code</em>.</li>
</ul>


<p>This implies that the following DSL examples(codes) are build with
sentences like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">);</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">Given</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">);</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">);</span> <span class="k">end</span>
</code></pre>
</div>


<p>Be aware, its respective gems may not define each DSL as I did, but it helps
to show different possible ways to do it.</p>

<p>Let's start with the examples.</p>

<h2>DSL implementations</h2>

<p>If you are doing Ruby then you probably have already used DSL's. Gems like
RSpec, Cucumber and Sinatra are good examples of DSL implementations. Let's
see their syntax and put special attention to the structures they use.</p>

<p>First, let's see three snippets from these languages.</p>

<h3>Rspec snippet</h3>

<p>In RSpec when you want to test if some object responds to a method call
you usually write something like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">describe</span> <span class="no">MyObject</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;should respond to a method call&#39;</span> <span class="k">do</span>
      <span class="n">subject</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:method_call</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>


<h3>Cucumber snippet</h3>

<p>In Cucumber when you write step definitions you do things like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="no">Given</span><span class="sr"> /^I click link &quot;([^&quot;&quot;]*)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
    <span class="n">find</span><span class="p">(</span><span class="ss">:css</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span><span class="o">.</span><span class="n">click</span>
  <span class="k">end</span>
</code></pre>
</div>


<h3>Sinatra snippet</h3>

<p>In Sinatra when you whant to write a route/controller you do something
like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
    <span class="s2">&quot;Hi there&quot;</span>
  <span class="k">end</span>
</code></pre>
</div>


<p>Now let's write our own DSL.</p>

<h2>Writing a DSL</h2>

<p>The following technique intention is similar to that from
<a href="http://guides.rubyonrails.org/action_controller_overview.html#filters">Rails Controller Filters</a>.</p>

<p>Let's build a DSL called <strong>Wrappable</strong>. <strong>Wrappable</strong> will be a simple custom DSL that
<em>wrap</em>'s' a method  with <em>callbacks</em> using the Ruby language.</p>

<p>Let me clarify what I mean by <em>wrap</em> using the following snippet:</p>

<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">before</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">original</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">after</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
</div>


<p><strong>Wrappable</strong> will <em>wrap</em> the <em>original</em> method. Whenever <em>original</em> is
invoked, the <em>before</em> method will be  automatically invoked first, second it
will invoke the <em>original</em> method and finally it will invoke the <em>after</em>
method.</p>

<p>The way the <em>before</em> and <em>after</em> methods behave is known as a
<a href="http://en.wikipedia.org/wiki/Callback_%28computer_programming%29">Callback</a>.</p>

<p>This behavior can also be achieved with something like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="k">def</span> <span class="nf">before</span><span class="p">;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">original</span>
    <span class="n">before</span>
    <span class="c1"># original sentences</span>
    <span class="n">after</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">after</span><span class="p">;</span> <span class="k">end</span>
</code></pre>
</div>


<p>But, I want to do this dynamically, using a <em>wrap</em> method that will be
able to setup the calls to the methods <em>before</em> and <em>after</em> programatically.</p>

<h3>Usage example</h3>

<p>We will end up the example with the following <strong>CallbackTest</strong> class:</p>

<div class="highlight"><pre><code class="ruby">    <span class="k">class</span> <span class="nc">CallbackTest</span>

      <span class="c1"># This module contains the whole functionality</span>
      <span class="kp">include</span> <span class="no">Wrappable</span>

      <span class="k">def</span> <span class="nf">original</span>
        <span class="nb">puts</span> <span class="s2">&quot;Original method&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">before</span>
        <span class="nb">puts</span> <span class="s2">&quot;Before method&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">after</span>
        <span class="nb">puts</span> <span class="s2">&quot;After method&quot;</span>
      <span class="k">end</span>

      <span class="n">wrap</span> <span class="ss">:original</span> <span class="k">do</span>
        <span class="n">before_run</span> <span class="ss">:before</span>
        <span class="n">after_run</span> <span class="ss">:after</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="no">CallbackTest</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">original</span>
</code></pre>
</div>


<p>The script output should be as follows:</p>

<div class="highlight"><pre><code class="bash">    ...<span class="nv">$ </span>ruby my_test.rb
    Before method
    Original method     
    After method
</code></pre>
</div>


<h3>Writing the callback step by step</h3>

<p>In order to build the whole example let's start by listing what we require
to do and then we will code the example from scratch.</p>

<h4>The requirements</h4>

<p>Consider the script fragment where <em>wrap</em> is invoked:</p>

<div class="highlight"><pre><code class="ruby">    <span class="n">wrap</span> <span class="ss">:original</span> <span class="k">do</span>
      <span class="n">before_run</span> <span class="ss">:before</span>
      <span class="n">after_run</span> <span class="ss">:after</span>
    <span class="k">end</span>
</code></pre>
</div>


<p>This means:</p>

<ul>
<li><strong>Step 1</strong>, we need a class method called <em>wrap</em>. The <em>wrap</em> method has two
parameters: The first is the *symbol representing the name of the method that
will be wrapped and the second is a block.</li>
<li><strong>Step 2</strong>, the block parameter contains two method calls that configure
what methods should be invoked: <em>before_run</em> and <em>after_run</em>. Each method
receives one parameter as symbol that represents the name of the method
that will be invoked respectively.</li>
<li><strong>Step 3</strong>, create the <em>wrap</em> behavior. This step involves creating a new
method that will eventually call the <em>original</em>, <em>before</em> and <em>after</em>
methods and implies that we need to keep a reference to the <em>original</em>
method so we do not overwrite it.</li>
</ul>


<h4>Step 1</h4>

<p>What we are going to do here is:
* Create a <strong>Wrappable</strong> module with an empty <em>wrap</em> method and its two
  parameters.
* Add the <strong>Wrappable</strong> module methods to the <strong>CallbackTest</strong> metaclass
  (adding static methods).
* Invoking the <strong>Wrappable</strong>'s <em>wrap</em> method inside <em>CallbackTest</em> class.</p>

<p>Now, save the following snippet as <em>callback_test.rb</em>:</p>

<div class="highlight"><pre><code class="ruby">    <span class="k">module</span> <span class="nn">Wrappable</span>
      <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">original_method</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">CallbackTest</span>

      <span class="kp">extend</span> <span class="no">Wrappable</span>

      <span class="k">def</span> <span class="nf">original</span>
        <span class="nb">puts</span> <span class="s2">&quot;Original method&quot;</span>
      <span class="k">end</span>

      <span class="n">wrap</span> <span class="ss">:original</span> <span class="k">do</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="no">CallbackTest</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">original</span>
</code></pre>
</div>


<p>Now execute it:</p>

<div class="highlight"><pre><code class="bash">    ...<span class="nv">$ </span>ruby callback_test.rb
    Original method
</code></pre>
</div>


<h4>Step 2</h4>

<p>What we are going to do here is:</p>

<ul>
<li>Invoke the <em>before_run</em> and <em>after_run</em> inside the <em>wrap</em>'s parameter block.</li>
<li>Create a <strong>WrapperOptions</strong> class.

<ul>
<li>This class will namespace the <em>before_run</em> and <em>after_run</em> methods.</li>
<li>I want the <em>wrap</em>'s parameter block to be evaluated inside this
<strong>WrapperOptions</strong> class.</li>
<li>By using this class we can handle all options parsing in just one place.</li>
</ul>
</li>
</ul>


<p>Update <em>callback_test.rb</em> with the following:</p>

<div class="highlight"><pre><code class="ruby">    <span class="k">module</span> <span class="nn">Wrappable</span>
      <span class="k">class</span> <span class="nc">WrapperOptions</span>
        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
          <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="kp">private</span>
        <span class="k">def</span> <span class="nf">before_run</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
          <span class="vi">@before</span> <span class="o">=</span> <span class="n">method_name</span>
        <span class="k">end</span>
        <span class="k">def</span> <span class="nf">after_run</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
          <span class="vi">@after</span> <span class="o">=</span> <span class="n">method_name</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">original_method</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">wrapper_options</span> <span class="o">=</span> <span class="no">WrapperOptions</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">CallbackTest</span>

      <span class="kp">extend</span> <span class="no">Wrappable</span>

      <span class="k">def</span> <span class="nf">original</span>
        <span class="nb">puts</span> <span class="s2">&quot;Original method&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">before</span>
        <span class="nb">puts</span> <span class="s2">&quot;Before method&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">after</span>
        <span class="nb">puts</span> <span class="s2">&quot;After method&quot;</span>
      <span class="k">end</span>

      <span class="n">wrap</span> <span class="ss">:original</span> <span class="k">do</span>
        <span class="n">before_run</span> <span class="ss">:before</span>
        <span class="n">after_run</span> <span class="ss">:after</span>
      <span class="k">end</span>

    <span class="k">end</span>

    <span class="no">CallbackTest</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">original</span>
</code></pre>
</div>


<p>And verify that your script still works:</p>

<div class="highlight"><pre><code class="bash">    ...<span class="nv">$ </span>ruby callback_test.rb
    Original method
</code></pre>
</div>


<h4>Step 3</h4>

<p>Our <strong>CallbackTest</strong> remains unchanged. Let's improve and complete the
<strong>Wrappable</strong> module. What we are going to do here is:</p>

<ul>
<li><em>Alias</em> the <em>original</em> method so we don't overwrite it.</li>
<li>Create <em>accessors</em> to our <em>wrapped</em> method names in the <strong>WrapperOptions</strong>
class.</li>
<li>Create a new method that will eventually call the <em>original</em>, <em>before</em> and
<em>after</em> methods.</li>
</ul>


<div class="highlight"><pre><code class="ruby">    <span class="k">module</span> <span class="nn">Wrappable</span>
      <span class="k">class</span> <span class="nc">WrapperOptions</span>
        <span class="kp">attr_reader</span> <span class="ss">:before</span><span class="p">,</span> <span class="ss">:after</span>
        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
          <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="kp">private</span>
        <span class="k">def</span> <span class="nf">before_run</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
          <span class="vi">@before</span> <span class="o">=</span> <span class="n">method_name</span>
        <span class="k">end</span>
        <span class="k">def</span> <span class="nf">after_run</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>
          <span class="vi">@after</span> <span class="o">=</span> <span class="n">method_name</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">original_method</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">wrapper_options</span> <span class="o">=</span> <span class="no">WrapperOptions</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">alias_method</span> <span class="ss">:old_method</span><span class="p">,</span> <span class="n">original_method</span>
        <span class="n">define_method</span> <span class="n">original_method</span> <span class="k">do</span>
          <span class="nb">send</span><span class="p">(</span><span class="n">wrapper_options</span><span class="o">.</span><span class="n">before</span><span class="p">)</span>
          <span class="nb">send</span><span class="p">(</span><span class="ss">:old_method</span><span class="p">)</span>
          <span class="nb">send</span><span class="p">(</span><span class="n">wrapper_options</span><span class="o">.</span><span class="n">after</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre>
</div>


<p>And finally test that the whole this script works:</p>

<div class="highlight"><pre><code class="bash">    ...<span class="nv">$ </span>ruby my_test.rb
    Before method
    Original method     
    After method
</code></pre>
</div>


<p>That's it.</p>

<h2>Conclusion</h2>

<p>This was a simple way to build a custom DSL, there are many DSL examples all
around the web for example:</p>

<ul>
<li>At <a href="http://deadprogrammersociety.blogspot.com/2006/11/ruby-domain-specific-languages-basics.html">Ron Evan's blog</a></li>
<li>At <a href="http://rubylearning.com/blog/2010/11/30/how-do-i-build-dsls-with-yield-and-instance_eval/">rubylearning.org's blog</a></li>
<li>At <a href="http://obiefernandez.com/presentations/obie_fernandez-agile_dsl_development_in_ruby.pdf">Obie Fernandez's blog</a></li>
</ul>


<p>Note that this implementation only supports method names as parameters, if
you want to view an example of transparently supporting <em>blocks</em> as wrappers
then look at the <a href="https://gist.github.com/762214">complete exercise gist</a>.</p>

<p>Finally, if you really need to implement callbacks then I recommend you to look at the
<a href="http://api.rubyonrails.org/classes/ActiveSupport/Callbacks.html"><strong>ActiveSupport::Callbacks</strong> package</a>.</p>

<p>Thank you for reading.</p>

<p>Regards</p>

    <div class="author_box">
      <p><b>Author:</b> Emmanuel Delgado | emmanuel.delgado@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/01/14/building-a-basic-dsl-to-create-callbacks-in-ruby.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="post prepend-1">
  <h1><a href="/2011/01/05/custom-sorting-with-ruby.html">Custom Sorting with Ruby</a></h1>
  <p class="author">
    <span class="date"><b>Jan 05</b><br />2011</span>
  </p>
  <div class="body prepend-1 append-1">
    <div class="gravatar span-3"><img src="http://www.gravatar.com/avatar/d32b52ec6403614b1adf3e648cbbe584" class="avatar" alt="Avatar" /></div>
    <p>Sometimes, sorting the elements in an array depend on something more
complex than just alphabetical order or numerical order.</p>

<p>From my experience, take for example shoe sizes for little kids.
For some of the vedors I've worked with you have shoes in size 10.5
through 13.5, then, the count is restarted to 1 through 9.</p>

<p>So, in order, the size array would look like this:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="mi">10</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">51</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="o">]</span>
</code></pre>
</div>


<h2>The problem</h2>

<p>Imagine we have those values on a sorted array:</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
<span class="mi">11</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span><span class="o">]</span>
</code></pre>
</div>


<p>How would we properly sort it? Well the answer is kinda simple. Extending ruby's sort
method.</p>

<p>For the sake of legibility, let's make a short version of the array.</p>

<p>Let's pretend for a moment that if we had this array</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">values</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span><span class="o">]</span>
</code></pre>
</div>


<p>It's sorted version should look like:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">values</span> <span class="o">=</span> <span class="o">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
</code></pre>
</div>


<p>In Ruby, all Enumerables (mostly array and hashes) have a sort method.
An example on how to use it would be:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">values</span> <span class="o">=</span> <span class="o">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
  <span class="n">values</span><span class="o">.</span><span class="n">sort</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span><span class="p">}</span>
</code></pre>
</div>


<p>This code would sort the array in numerical order. The first thime I saw
this code, one thing came to my mind: What is that <em>&lt;=></em> operator?</p>

<p>To understand that, let's first figure out how the <em>sort</em> method works.</p>

<h2>The sort method</h2>

<p>The sort method takes the elements on the enumerable in pairs,
receives a block, and expects the result of the block to be:</p>

<div class="highlight"><pre><code class="ruby">   <span class="o">-</span><span class="mi">1</span>  <span class="k">when</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span>

    <span class="mi">0</span>  <span class="k">when</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>

    <span class="mi">1</span>  <span class="k">when</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span>
</code></pre>
</div>


<p>Based on the result of that block, the sort method returns the
array in order.</p>

<h2>The &lt;=> operator</h2>

<p>That means the <em>&lt;=></em> operator, compares both elements on its sides
and returns <em>-1, 0, 1</em> depending on the values.</p>

<p>An example of how it works for the Fixnum class:</p>

<div class="highlight"><pre><code class="ruby"><span class="mi">1</span> <span class="o">&lt;=&gt;</span> <span class="mi">2</span> <span class="c1"># =&gt; -1</span>
<span class="mi">3</span> <span class="o">&lt;=&gt;</span> <span class="mi">3</span> <span class="c1"># =&gt; 0 </span>
<span class="mi">4</span> <span class="o">&lt;=&gt;</span> <span class="mi">1</span> <span class="c1"># =&gt; 1</span>
</code></pre>
</div>


<p>Go on, try that on <em>irb</em>.</p>

<p>In our case, we will use a custom function to return <em>-1, 0, 1</em> depending
on the value of <em>a</em> and <em>b</em>.</p>

<p>For this example, let's just put it on a Comparison class:</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Comparison</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">little_kid_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>So, the way we'll use this method will be:</p>

<div class="highlight"><pre><code class="ruby">  <span class="n">values</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">5</span><span class="o">]</span>
  <span class="n">values</span><span class="o">.</span><span class="n">sort</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">|</span> <span class="no">Comparison</span><span class="o">.</span><span class="n">little_kid_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">}</span> <span class="c1">#=&gt; [12, 12.5, 13, 13.5, 1, 1.5, 2, 2.5, 3]</span>
</code></pre>
</div>


<p>To solve this problem, first thing we need to do is assign a weight to
the two sets of sizes: -1 to [12, 12.5, 13, 13.5] and 1 to [1, 1.5, 2,
2.5, 3].</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Comparison</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">little_kid_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">little_kid_size_weight</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">?</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>Now, we'll use that weight calculation to determine the sort order of
the elements.</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Comparison</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">little_kid_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># If the weights are the same, compare them numerically</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">little_kid_size_weight</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">little_kid_size_weight</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
      <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span>

    <span class="c1">#</span>
    <span class="c1"># If the weights are different, just return the weight of a</span>
    <span class="c1">#</span>
    <span class="k">else</span>
      <span class="n">little_kid_size_weight</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">little_kid_size_weight</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">?</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>


<p>And that's it, you can try it on irb as it is.</p>

<h2>Conclusion</h2>

<p>All you have to remember is to make the result of the sort block
return -1, 0, 1 depending on how you want to sort the values.</p>

<p>If the sizes were stored, for example, on a ShoeSize model, the best
thing to do is override the ShoeSize class <em>&lt;=></em> operator. That would
actually look much better, but you can always implement the sort methods on a
Module, or an external class to reuse them.</p>

<p>Hope this helps you somehow.</p>

    <div class="author_box">
      <p><b>Author:</b> David Padilla | david@crowdint.com</p>
    </div>
    <div class="tweet">
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <div class="comments">
      <h2><a href="/2011/01/05/custom-sorting-with-ruby.html#disqus_thread">Click here for Comments</a></h2>
    </div>
  </div>
</div>


<div class="pagination prepend-1">
  
    <a href="/page2" class="previous">Previous</a>
  
  <span class="page_number ">Page: 3 of 13</span>
  
    <a href="/page4" class="next ">Next</a>
  
</div>






<div class="post prepend-1">
  <h1>Recent Posts</h1>
  <ul class="archives">

  <li><span><b>02 Mar 2011</b></span> &raquo; <a href="/2011/03/02/how-to-make-your-models-look-lean.html">How to make your Models look lean</a></li>

  <li><span><b>25 Feb 2011</b></span> &raquo; <a href="/2011/02/25/why-ruby.html">Why ruby?</a></li>

  <li><span><b>21 Feb 2011</b></span> &raquo; <a href="/2011/02/21/what-we-learned-at-la-ruby-conf.html">What we learned at LA Ruby Conf</a></li>

  <li><span><b>15 Feb 2011</b></span> &raquo; <a href="/2011/02/15/internationalizing-your-rails-app.html">Internationalizing your Rails application with i18n</a></li>

  <li><span><b>05 Feb 2011</b></span> &raquo; <a href="/2011/02/05/auditrail-how-to-play-dirty-with-callbacks.html">Auditrail, how to play dirty with callbacks.</a></li>

  <li><span><b>31 Jan 2011</b></span> &raquo; <a href="/2011/01/31/attack-of-the-backticks.html">Attack of the backtick</a></li>

  <li><span><b>24 Jan 2011</b></span> &raquo; <a href="/2011/01/24/how-to-start-writing-a-gem.html">How to start writing a ruby gem</a></li>

  <li><span><b>14 Jan 2011</b></span> &raquo; <a href="/2011/01/14/building-a-basic-dsl-to-create-callbacks-in-ruby.html">Building a basic DSL to create callbacks in Ruby</a></li>

  <li><span><b>05 Jan 2011</b></span> &raquo; <a href="/2011/01/05/custom-sorting-with-ruby.html">Custom Sorting with Ruby</a></li>

  <li><span><b>25 Dec 2010</b></span> &raquo; <a href="/2010/12/25/happy-holidays-from-crowd-interactive.html">Happy Holidays, your friends from Crowd Interactive</a></li>

  <li><span><b>21 Dec 2010</b></span> &raquo; <a href="/2010/12/21/cool-date-formatting-in-rails.html">Cool date formatting in Rails</a></li>

  <li><span><b>15 Dec 2010</b></span> &raquo; <a href="/2010/12/15/always-think-restful.html">Always Think RESTful</a></li>

  <li><span><b>07 Dec 2010</b></span> &raquo; <a href="/2010/12/07/improving-your-dev-life-with-ree.html">Improving your development life with Ruby Enterprise Edition</a></li>

  <li><span><b>30 Nov 2010</b></span> &raquo; <a href="/2010/11/30/rspec-for-really-newbies.html">RSpec for really newbies</a></li>

  <li><span><b>24 Nov 2010</b></span> &raquo; <a href="/2010/11/24/watermarking-images.html">Watermarking images minimizing the overhead</a></li>

  <li><span><b>17 Nov 2010</b></span> &raquo; <a href="/2010/11/17/rack-basics-a-rack-introduction.html">Rack Basics - A Rack Introduction</a></li>

  <li><span><b>11 Nov 2010</b></span> &raquo; <a href="/2010/11/11/subdomains-in-rails-2-and-3.html">Subdomains in Rails (2.3.x &amp; 3)</a></li>

  <li><span><b>05 Nov 2010</b></span> &raquo; <a href="/2010/11/05/controller-responders-in-rails-3.html">Controller responders in Rails 3</a></li>

  <li><span><b>01 Nov 2010</b></span> &raquo; <a href="/2010/11/01/ignoring-files-with-git.html">Ignoring files with Git</a></li>

  <li><span><b>27 Oct 2010</b></span> &raquo; <a href="/2010/10/27/working-with-postgresql-and-rails3.html">Working with PostgreSQL and Rails3</a></li>

  </ul>
</div>

        </div>
        <div class="right-side span-5 last prepend-1">
          <h1><a href="/">Blog Home</a></h1>
<h1>About Crowd Interactive</h1>
<p class="append-1 about">Crowd Interactive is a Ruby on Rails
consultancy firm powered by a team of enthusiast engineers that love
programming.We turn your ideas into web applications...<br/><a href="/about.html">Read More...</a></p>
<div id="writeSkribitHere"></div><script src="http://assets.skribit.com/javascripts/SkribitWidget.js?renderTo=writeSkribitHere&amp;blog=ef56d1750b6040b271e0080ef2886f3b&amp;cnt=5&noCSS=1"></script><noscript>Sorry, but the <a href="http://skribit.com" title="Skribit - Cure Writer's Block">Skribit</a> widget only works on browsers with JavaScript support.  <a href="http://skribit.com/blogs/crowdint-tech" title="Skribit Suggestions for Crowdint Tech">View suggestions for this blog here.</a></noscript>
<h1>Our Favorite Sites</h1>
<ul>
  <li><a href="http://www.crowdint.com">Crowd Interactive</a></li>
  <li><a href="http://www.magmarails.com">MagmaRails</a></li>
  <li><a href="http://rubyonrails.org">Ruby on Rails</a></li>
  <li><a href="http://ruby-lang.org">Ruby-Lang</a></li>
  <li><a href="http://github.com/crowdint">Github</a></li>
</ul>
<h1>Stuff we've built</h1>
<ul>
  <li><a href="http://www.modcloth.com">ModCloth</a></li>
  <li><a href="http://www.creativeallies.com">Creative Allies</a></li>
  <li><a href="http://www.nameframe.com">Nameframe</a></li>
  <li><a href="http://github.com/crowdint/rails3-jquery-autocomplete">Rails3-jQuery-Autocomplete</a></li>
  <li><a href="http://github.com/crowdint/rankstar">rankstar</a></li>
  <li><a href="http://github.com/crowdint/blog.crowdint.com">This site's source code</a></li>
</ul>
<h1>Older Posts</h1>
<ul>
  <li><a href="/archive.html">Archive</a></li>
</ul>

Site Powered by <a href="http://github.com/mojombo/jekyll">Jekyll</a>

        </div>
      </div>
      <div class="round-bottom span-24">
        &nbsp;
      </div>
    </div>

  </div>
  <div id="footer">
    <div class="copyContent" >
      <p class="copy">Copyright &copy; 2010, Crowd Interactive. All rights reserved.</p>
    </div>
  </div>
  <script type="text/javascript">
  var disqus_shortname = 'crowdinttech';
  (function () {
    var s = document.createElement('script'); s.async = true;
    s.src = 'http://disqus.com/forums/crowdinttech/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
  </script>
</body>
</html>
